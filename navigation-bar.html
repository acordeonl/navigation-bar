<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<!--

Shows drop down menu (works on chrome)

### Usage
The list displayed in the drop down menu can be set as an attribute.

    <drop-menu list-items='["first" ,"second"]'></drop-menu>

For an overlayed drop menu:

    <drop-menu overlay-menu list-items='["first" ,"second"]'></drop-menu>

### Styling
 Custom property | Description | Default
----------------|-------------|----------
`--item-background-color` | List item backround color | `#f1ecef`
`--item-color` | List item color used for fonts | `#302f31`
`--theme-color1` | Icon button hover color | `4775D1`
`--content-background` | Drop menu's background color | `white`
`--theme-color1` | Icon button hover color | `4775D1`
`--icon-button` | Mixin applied the icon button | `{}`

@demo demo/drop-menu-demo.html
-->
<dom-module id="navigation-bar">
    <template>
        <style>
            :host {
                --bar-color: var(--theme-color1,#4775D1);
                --knob-color: var(--theme-color10,#3F69BC);
            }
            canvas{
                @apply(--shadow-elevation-3dp);
                cursor: pointer;
                position: relative;;
            }
            [navigation-progress] {
                background-color: var(--background-color,#efebe9);
                height: 50px;
                top: 0;
                width:100% ;
                transform-origin: 0% 50% ;
                border-right: 5px solid var(--knob-color);
            }
            [marker] {
                background-color: var(--background-color0,#D7D3D1);
                position: absolute;
                left: 20%;
                width: 5px;
                height: 50px;
            }
            [percentage] {
                position: absolute;
                top: 15px;
                font-size: 15px;
                color: white;
                font-weight: 400;
            }
            [start-time] {
                left: 10px;
                color: var(--content-background,#fafafa);
            }
            [end-time] {
                right: 10px;
                color: #a7a6ab;
            }
        </style>
        </div navigation-progress>
            <canvas title="[[title]]" ></canvas>
            <div percentage start-time>[[_computeMMSS(startTime)]]</div>
            <div percentage end-time>[[_computeMMSS(endTime)]]</div>
        </div>
        <!-- <div on-track='_handleTrack' navigation-container >
            <div navigation-progress ></div>
            <template is="dom-repeat" items="[[markers]]" as="marker">
                <div marker style$='left:[[marker.position]]%;'></div>
            </template>

        </div> -->
    </template>
    <script>
        Polymer({
            is: "navigation-bar",
            observers: [],
            behaviors: [
                Polymer.IronResizableBehavior
            ],
            listeners: {
                'iron-resize': '_resizeCanvas',
                'click': '_setProgress',
                'mousemove': '_showTime'
            },
            properties: {
                ctx:{
                    type:Object
                },
                clientX:{
                    type:Number
                },
                previousRectX:{
                    type:Object
                },
                scrolling:{
                    type:Boolean,
                    value:false
                },
                markers: {
                    type: Array,
                    value: []
                },
                title: {
                    type: Number,
                    value: 0
                },
                startTime: {
                    type: Number,
                    value: 0
                },
                endTime: {
                    type: Number,
                    value: 0
                },
                progress: {
                    type: Number,
                    value: 0
                },
                firingProgress: {
                    type: Boolean,
                    value: false
                }
            },
            _drawRect: function(x,y,w,h,color){
                this.ctx.beginPath() ;
                this.ctx.rect(x,y,w,h);
                this.ctx.fillStyle = color ;
                this.ctx.fill();
                this.ctx.closePath() ;
            },
            update: function(){
                this.ctx.clearRect(0, 0, window.innerWidth, 50);
                this.ctx.clearRect(0, 0, window.innerWidth, 50);
                var progress = Math.round(this.progress * 10) / 10 ;
                this._drawRect(0,0,progress/100*window.innerWidth,50,'#4775D1') ;
                this._drawRect(progress/100*window.innerWidth,0,5,50,'#0000ff') ;
                for (var i = 0; i < this.markers.length; i++) {
                    var x = this.markers[i].position/100*window.innerWidth  ;
                    this._drawRect(x,0,5,50,'#cccccc') ;
                }
            },
            clearMarkers: function () {
                this.markers = [];
            },
            addMarker: function (id, position) {
                this.push('markers', {
                    id: id,
                    position: position
                });
            },
            removeMarker: function (id) {
                for (var i = 0; i < this.markers.length; i++) {
                    if (this.markers[i].id === id) {
                        this.splice('markers', i, 1);
                        return;
                    }
                }
            },
            _showTime: function (e) {
                this.title = this._computeMMSS((e.x / window.innerWidth) * (this.endTime - this.startTime) + this.startTime);
            },
            _computeTitleMMSS: function (progress) {
                var tmp = (progress / 100) * (this.endTime - this.startTime) + this.startTime;
                return this._computeMMSS(tmp);
            },
            _computeMMSS: function (time) {
                var minutes = Math.floor(time / 60);
                var seconds = Math.floor((time - (minutes * 60)));
                if (seconds < 10)
                    return minutes + ':0' + seconds;
                else {
                    return minutes + ':' + seconds;
                }
            },
            _handleTrack: function (e) {
                this.scrolling = true ;
                if(e.detail.ddx === undefined)
                    return ;
                this.fire('nav-bar-scroll',{scroll:e.detail.ddx}) ;
                this.async(function(){
                    this.scrolling = false ;
                } , 200 )  ;
            },
            _setProgress: function (e) {
                if (!this.firingProgress && !this.scrolling ) {
                    this.firingProgress = true;
                    this.fire('set-nav-progress', {
                        progress: e.clientX / window.innerWidth*100
                    });
                    this.async(function () {
                        this.firingProgress = false;
                    }, 100);
                }
            },
            _resizeCanvas:function() {
                this.$$('CANVAS').width = window.innerWidth;
                this.$$('CANVAS').height = '50';
                this.ctx = this.$$('CANVAS').getContext('2d') ;
            },
            attached: function() {
                window.addEventListener('resize', this._resizeCanvas.bind(this));
            },
            ready: function () {
                this._resizeCanvas() ;
            }
        });
    </script>
</dom-module>
